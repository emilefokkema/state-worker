!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("path"),require("worker_threads")):"function"==typeof define&&define.amd?define(["path","worker_threads"],t):"object"==typeof exports?exports.StateWorker=t(require("path"),require("worker_threads")):e.StateWorker=t(e.path,e.worker_threads)}(this,(function(e,t){return(()=>{var s={807:(e,t,s)=>{"use strict";s.r(t),s.d(t,{createChildProcessFactory:()=>h});const n=s(56),{NodeChildProcess:r}=s(975);class i{constructor(){this.stateWorkerInstancePath=void 0}get baseURI(){}createChildProcess(e){return this.stateWorkerInstancePath||(this.stateWorkerInstancePath=n.resolve(__dirname,"./child-process.js")),r.create(this.stateWorkerInstancePath)}}var u=s(239);class o{constructor(e){this.worker=e}addListener(e){this.worker.addEventListener("message",e)}removeListener(e){this.worker.removeEventListener("message",e)}}class a{constructor(e){this.worker=e,this.workerMessageEventSource=(0,u.z)(new o(e),(e=>({data:t})=>e(t)))}terminate(){this.worker&&(this.worker.terminate(),this.worker=void 0)}sendMessage(e){this.worker.postMessage(e)}addMessageEventListener(e){this.workerMessageEventSource.addListener(e)}removeMessageEventListener(e){this.workerMessageEventSource.removeListener(e)}static create(e,t){const s=new Worker(e,{type:t?"module":"classic"});return s.addEventListener("error",(e=>{console.log(e)})),new a(s)}}class c{constructor(){this.childProcessScriptPath=void 0}get baseURI(){return document.baseURI}createChildProcess(e){return this.childProcessScriptPath||(this.childProcessScriptPath=URL.createObjectURL(new Blob(["self.req = function(url){return import(url);};","(()=>{\"use strict\";class e{constructor(e){this.process=e}addListener(e){this.process.addMessageEventListener(e)}removeListener(e){this.process.removeMessageEventListener(e)}}class s extends class{constructor(){this.listeners=[]}addListener(e){this.listeners.push(e)}removeListener(e){const s=this.listeners.indexOf(e);-1!==s&&this.listeners.splice(s,1)}dispatch(...e){const s=this.listeners.slice();for(let t of s)t(...e)}}{constructor(){super(),this.cancelled=!1}cancel(){this.dispatch()}dispatch(){this.cancelled||(super.dispatch(),this.cancelled=!0,this.listeners.splice(0,this.listeners.length))}addListener(e){this.cancelled?e():super.addListener(e)}}class t{constructor(e,s){this.eventSource=e,this.mapFn=s,this.listeners=[]}addListener(e){const t={cancellationToken:new s},n=this.mapFn.apply(t,[e]);t.listener=e,t.mappedListener=n,this.listeners.push(t),this.eventSource.addListener(n)}removeListener(e){const s=this.listeners.findIndex((s=>s.listener===e));if(-1===s)return;const[t]=this.listeners.splice(s,1);this.eventSource.removeListener(t.mappedListener),t.cancellationToken.cancel()}}function n(e,s){return new t(e,s)}function r(e,s){return s?n(e,(e=>(...t)=>{s(...t)&&e(...t)})):e}class i{constructor(s){this.process=s,this.processRequestMessage=n(r(new e(s),(({type:e})=>\"request\"===e)),(e=>({requestId:s,request:t})=>{e(t,(e=>{this.process.sendMessage({type:\"response\",requestId:s,response:e})}))}))}addListener(e){this.processRequestMessage.addListener(e)}removeListener(e){this.processRequestMessage.removeListener(e)}}class o{constructor(e){this.eventSource=e}addListener(e,s){this.eventSource.addListener(e),s&&s.addListener((()=>{this.removeListener(e)}))}removeListener(e){this.eventSource.removeListener(e)}}class a{constructor(s){this.process=s,this.processResponseMessage=r(new e(s),(({type:e})=>\"response\"===e)),this.latestRequestId=0}async getResponse(e){const s=this.latestRequestId++,t=(n=r(this.processResponseMessage,(({requestId:e})=>e===s)),i&&(n=function(e){return new o(e)}(n)),new Promise((e=>{const s=(...t)=>{n.removeListener(s),e(t)};n.addListener(s,i)})));var n,i;this.process.sendMessage({type:\"request\",requestId:s,request:e});const[{response:a}]=await t;return a}}var c;!function(e,s){let t,n,r;s.onInitializationRequested.addListener((async({config:s,baseURI:i,state:o},a)=>{try{if(({commands:t,queries:n}=await e.importMethods(s,i)),t=t||{},n=n||{},\"object\"!=typeof t)return void a({error:\"Exported member 'commands' is not an object\"});if(\"object\"!=typeof n)return void a({error:\"Exported member 'queries' is not an object\"});const c=Object.getOwnPropertyNames(n),d=Object.getOwnPropertyNames(t);if(c.includes(\"terminate\")||d.includes(\"terminate\"))return void a({error:\"'terminate' cannot be used as the name of a command or a query\"});r=o,a({methodCollection:{queries:c,commands:d}})}catch(e){a({error:e.toString()})}})),s.onSetStateRequested.addListener((({state:e},s)=>{r=e,s()})),s.onExecutionRequested.addListener((({methodName:e,args:i,id:o},a)=>{const c=n[e],d=t[e],u=d||c,p=u===d,l=function(e){return{state:r,async await(t){if(!(t instanceof Promise))return t;let n,r;s.notifyIdle();try{n=await t}catch(e){r=e}if(await s.requestIdle(e),void 0!==r)throw r;return n}}}(o);try{const e=u.apply(l,i);if(r=l.state,e instanceof Promise)e.then((e=>{r=l.state;const s={result:e};p&&(s.state=r),a(s)})).catch((e=>{r=l.state;const s={error:e.toString()};p&&(s.state=r),a(s)}));else{const s={result:e};p&&(s.state=r),a(s)}}catch(e){r=l.state;const s={error:e.toString()};p&&(s.state=r),a(s)}})),s.notifyStarted()}(new class{async importMethods(e,s){const t=new URL(e.path,s);return e.module?await req(t.toString()):(importScripts(t.toString()),\"undefined\"==typeof commands?\"undefined\"==typeof queries?{commands:{},queries:{}}:{queries,commands:{}}:\"undefined\"==typeof queries?{queries:{},commands}:{commands,queries})}},(c=new class{constructor(){this.listeners=[]}sendMessage(e){postMessage(e)}addMessageEventListener(e){const s=({data:s})=>{e(s)};this.listeners.push({listener:e,mappedListener:s}),addEventListener(\"message\",s)}removeMessageEventListener(e){const s=this.listeners.findIndex((s=>s.listener===e));if(-1===s)return;const[t]=this.listeners.splice(s,1);removeEventListener(\"message\",t.mappedListener)}},new class{constructor(e){this.parentProcess=e;const s=new i(e);this.onExecutionRequested=r(s,(({type:e})=>\"execution\"===e)),this.onSetStateRequested=r(s,(({type:e})=>\"setState\"===e)),this.onInitializationRequested=r(s,(({type:e})=>\"initialize\"===e)),this.requestTarget=new a(e)}notifyStarted(){this.parentProcess.sendMessage({type:\"started\"})}notifyIdle(){this.parentProcess.sendMessage({type:\"idle\"})}requestIdle(e){return this.requestTarget.getResponse({type:\"requestIdle\",executionId:e})}}(c)))})();"],{type:"application/javascript"}))),a.create(this.childProcessScriptPath,!!e.module)}}function h(){return"undefined"==typeof window?new i:new c}},566:(e,t,s)=>{"use strict";s.r(t),s.d(t,{wrapChildProcess:()=>h});class n{constructor(e){this.process=e}addListener(e){this.process.addMessageEventListener(e)}removeListener(e){this.process.removeMessageEventListener(e)}}var r=s(167),i=s(240);class u{constructor(e){this.process=e,this.processResponseMessage=(0,r.h)(new n(e),(({type:e})=>"response"===e)),this.latestRequestId=0}async getResponse(e){const t=this.latestRequestId++,s=(0,i.h)((0,r.h)(this.processResponseMessage,(({requestId:e})=>e===t)));this.process.sendMessage({type:"request",requestId:t,request:e});const[{response:n}]=await s;return n}}var o=s(239);class a{constructor(e){this.process=e,this.processRequestMessage=(0,o.z)((0,r.h)(new n(e),(({type:e})=>"request"===e)),(e=>({requestId:t,request:s})=>{e(s,(e=>{this.process.sendMessage({type:"response",requestId:t,response:e})}))}))}addListener(e){this.processRequestMessage.addListener(e)}removeListener(e){this.processRequestMessage.removeListener(e)}}class c{constructor(e){this.childProcess=e;const t=new n(e);this.startedMessage=(0,r.h)(t,(({type:e})=>"started"===e)),this.onIdle=(0,r.h)(t,(({type:e})=>"idle"===e)),this.requestTarget=new u(e);const s=new a(e);this.onIdleRequested=(0,r.h)(s,(({type:e})=>"requestIdle"===e)),this.hasStarted=!1,(0,i.h)(this.startedMessage).then((()=>{this.hasStarted=!0}))}terminate(){this.childProcess.terminate()}async whenStarted(){if(await new Promise((e=>setTimeout(e,0))),!this.hasStarted)return(0,i.h)(this.startedMessage)}setState(e){return this.requestTarget.getResponse({type:"setState",state:e})}performExecution(e){return this.requestTarget.getResponse({type:"execution",methodName:e.methodName,args:e.args,id:e.id})}initialize(e,t,s){return this.requestTarget.getResponse({type:"initialize",config:e,baseURI:t,state:s})}}function h(e){return new c(e)}},908:(e,t,s)=>{"use strict";s.d(t,{T:()=>r});var n=s(119);class r extends n.j{constructor(){super(),this.cancelled=!1}cancel(){this.dispatch()}dispatch(){this.cancelled||(super.dispatch(),this.cancelled=!0,this.listeners.splice(0,this.listeners.length))}addListener(e){this.cancelled?e():super.addListener(e)}}},119:(e,t,s)=>{"use strict";s.d(t,{j:()=>n});class n{constructor(){this.listeners=[]}addListener(e){this.listeners.push(e)}removeListener(e){const t=this.listeners.indexOf(e);-1!==t&&this.listeners.splice(t,1)}dispatch(...e){const t=this.listeners.slice();for(let s of t)s(...e)}}},167:(e,t,s)=>{"use strict";s.d(t,{h:()=>r});var n=s(239);function r(e,t){return t?(0,n.z)(e,(e=>(...s)=>{t(...s)&&e(...s)})):e}},240:(e,t,s)=>{"use strict";s.d(t,{h:()=>r});class n{constructor(e){this.eventSource=e}addListener(e,t){this.eventSource.addListener(e),t&&t.addListener((()=>{this.removeListener(e)}))}removeListener(e){this.eventSource.removeListener(e)}}function r(e,t){return t&&(e=function(e){return new n(e)}(e)),new Promise((s=>{const n=(...t)=>{e.removeListener(n),s(t)};e.addListener(n,t)}))}},239:(e,t,s)=>{"use strict";s.d(t,{z:()=>i});var n=s(908);class r{constructor(e,t){this.eventSource=e,this.mapFn=t,this.listeners=[]}addListener(e){const t={cancellationToken:new n.T},s=this.mapFn.apply(t,[e]);t.listener=e,t.mappedListener=s,this.listeners.push(t),this.eventSource.addListener(s)}removeListener(e){const t=this.listeners.findIndex((t=>t.listener===e));if(-1===t)return;const[s]=this.listeners.splice(t,1);this.eventSource.removeListener(s.mappedListener),s.cancellationToken.cancel()}}function i(e,t){return new r(e,t)}},138:(e,t,s)=>{const{createChildProcessFactory:n}=s(807),{createStateWorkerFactory:r}=s(925),{wrapChildProcess:i}=s(566),u=r(n,i);e.exports={create:u}},975:(e,t,s)=>{const n=s(716);class r{constructor(e){this.worker=e}terminate(){this.worker.terminate()}sendMessage(e){this.worker.postMessage(e)}addMessageEventListener(e){this.worker.addListener("message",e)}removeMessageEventListener(e){this.worker.removeListener("message",e)}static create(e){const t=new n.Worker(e);return t.on("error",(e=>{console.log("error from worker",e)})),new r(t)}}e.exports={NodeChildProcess:r}},925:(e,t,s)=>{"use strict";s.r(t),s.d(t,{createStateWorkerFactory:()=>L});var n=s(908);class r{constructor(e,t,s,r){this.methodName=t,this.args=s,this.isCommand=r,this.id=e,this.cancellationToken=new n.T}toString(){return`[#${this.id}] ${this.methodName}(${this.args.map((e=>JSON.stringify(e))).join(", ")})`}}class i{constructor(){this.cancellationToken=new n.T}}var u=s(119),o=s(240),a=s(167);async function c(e){throw await(0,o.h)(e),new Error}class h{constructor(){this.previousBack=null,this.nextFront=null}detach(){const e=this.previousBack,t=this.nextFront;return this.previousBack=null,this.nextFront=null,e&&(e.nextFront=t),t&&(t.previousBack=e),t}appendToBack(e){const t=this.findBack();t.nextFront=e,e.previousBack=t}findBack(){return this.nextFront?this.nextFront.findBack():this}accept(e){if(e=this.acceptSelf(e))return null!==this.nextFront?this.nextFront.accept(e):e}toString(){let e=this.selfToString();return this.nextFront?`${e} --\x3e ${this.nextFront.toString()}`:e}}class l extends h{constructor(e){super(),this.value=e}acceptSelf(e){return e.visitValue(this)}selfToString(){return`{${this.value}}`}}class d{constructor(){this.result=null,this.queueFronts=[]}visitQueueFront(e,t){return this.queueFronts.push({queue:e,front:t}),this}visitQueue(){return this}visitValue(){return this}getItemAndQueue(){if(!this.result)return{};let e;const t=this.queueFronts.find((e=>e.front===this.result));return t&&(e=t.queue),{item:this.result,queue:e}}}class p extends d{constructor(e){super(),this.value=e}visitValue(e){if(e.value!==this.value)return this;this.result=e}}class m extends d{visitValue(e){this.result=e}}class q extends d{constructor(e){super(),this.queue=e}visitQueue(e){if(e!==this.queue)return this;this.result=e}}class f extends h{constructor(){super(),this.front=null}enqueueQueue(){const e=new f;return this.enqueueItem(e),e}embedQueue(){return new g(this)}useAsFallbackFor(e){return new I(e,this)}enqueue(e){this.enqueueItem(new l(e))}enqueueItem(e){null===this.front?this.front=e:this.front.appendToBack(e)}dequeue(){const e=this.removeItem(new m);return e?e.value:null}removeQueue(e){this.removeItem(new q(e))}remove(e){return!!this.removeItem(new p(e))}contains(e){const{item:t}=this.findItem(new p(e));return!!t}findItem(e){return this.accept(e),e.getItemAndQueue()}removeItem(e){const{item:t,queue:s}=this.findItem(e);let n;return t?(n=t.detach(),s&&(s.front=n),t):null}empty(){const{item:e}=this.findItem(new m);return!e}peek(){const{item:e}=this.findItem(new m);return e?e.value:null}acceptSelf(e){if(e=e.visitQueue(this)){if(null!==this.front){if(!(e=e.visitQueueFront(this,this.front)))return;return this.front.accept(e)}return e}}selfToString(){return`[${this.front?this.front.toString():""}]`}}class w{constructor(e){this.queueBack=e}enqueue(e){this.queueBack.enqueue(e)}enqueueQueue(){const e=this.queueBack.enqueueQueue();return new w(e)}remove(e){this.queueBack.remove(e)}removeQueue(e){this.queueBack.removeQueue(e.queueBack)}}class I{constructor(e,t){this.queue=e,this.queueBack=new w(this.queue),this.fallback=t}enqueueQueue(){return this.queueBack.enqueueQueue()}remove(e){this.queueBack.remove(e)}removeQueue(e){this.queueBack.removeQueue(e)}enqueue(e){this.queueBack.enqueue(e)}dequeue(){return this.queue.empty()?this.fallback.dequeue():this.queue.dequeue()}empty(){return this.queue.empty()&&this.fallback.empty()}}class v{constructor(e,t){this.queueBack=e,this.baseQueueBack=t}enqueue(e){this.baseQueueBack.enqueue(e),this.queueBack.enqueue(e)}enqueueQueue(){const e=this.baseQueueBack.enqueueQueue(),t=this.queueBack.enqueueQueue();return new v(t,e)}remove(e){this.queueBack.remove(e),this.baseQueueBack.remove(e)}removeQueue(e){this.queueBack.removeQueue(e.queueBack),this.baseQueueBack.removeQueue(e.baseQueueBack)}}class g{constructor(e){this.baseQueue=e,this.queue=new f,this.queueBack=new v(this.queue,this.baseQueue)}enqueueQueue(){return this.queueBack.enqueueQueue()}remove(e){this.queueBack.remove(e)}removeQueue(e){this.queueBack.removeQueue(e)}enqueue(e){this.queueBack.enqueue(e)}prune(){for(;!this.queue.empty()&&!this.baseQueue.contains(this.queue.peek());)this.queue.dequeue()}dequeue(){if(this.prune(),this.queue.empty())return null;const e=this.queue.dequeue();return this.baseQueue.remove(e),e}empty(){return this.prune(),this.queue.empty()}toString(){return`base: ${this.baseQueue.toString()}\r\nqueue: ${this.queue.toString()}`}}class Q{constructor(e,t){this.requestQueue=e,this.responseQueue=t}enqueueRequestQueue(){const e=this.requestQueue.enqueueQueue();return new Q(e,this.responseQueue)}removeRequestQueue(e){this.requestQueue.removeQueue(e.requestQueue)}hasResponse(){return!this.responseQueue.empty()}async getResponse(e){return this.responseQueue.empty()?await new Promise((t=>{const s={resolve:t};this.requestQueue.enqueue(s),e&&e.addListener((()=>{this.requestQueue.remove(s)}))})):this.responseQueue.dequeue()}}class k{constructor(e,t){this.requestQueue=e,this.responseQueue=t,this.requestQueueBack=new Q(this.requestQueue,this.responseQueue)}enqueueRequestQueue(){return this.requestQueueBack.enqueueRequestQueue()}removeRequestQueue(e){this.requestQueueBack.removeRequestQueue(e)}hasResponse(){return this.requestQueueBack.hasResponse()}getResponse(e){return this.requestQueueBack.getResponse(e)}addResponse(e){this.requestQueue.empty()?this.responseQueue.enqueue(e):this.requestQueue.dequeue().resolve(e)}}var R=s(239);class x{constructor(e){this.requestAndResponseQueue=e}whenIdle(e){return this.requestAndResponseQueue.getResponse(e)}enqueueIdleRequestQueue(){const e=this.requestAndResponseQueue.enqueueRequestQueue();return new x(e)}removeIdleRequestQueue(e){this.requestAndResponseQueue.removeRequestQueue(e.requestAndResponseQueue)}}class y{constructor(e,t,s){this.instance=e,this.terminated=!1,this.idleRequestResponseQueue=new k(t,s),this.idleRequestQueue=new x(this.idleRequestResponseQueue),e.onIdle.addListener((()=>{this.idleAllowed&&this.setIdle()})),this.idleAllowed=!0,this.onIdleRequested=(0,R.z)(e.onIdleRequested,(e=>({executionId:t},s)=>{this.idleAllowed?e({executionId:t},s):s()}))}get idle(){return this.idleRequestResponseQueue.hasResponse()}allowIdle(e){this.idleAllowed=e}performExecution(e){return this.instance.performExecution(e)}whenStarted(){return this.instance.whenStarted()}setState(e){return this.instance.setState(e)}initialize(e,t,s){return this.instance.initialize(e,t,s)}terminate(){this.instance.terminate(),this.terminated=!0}enqueueIdleRequestQueue(){return this.idleRequestQueue.enqueueIdleRequestQueue()}removeIdleRequestQueue(e){this.idleRequestQueue.removeIdleRequestQueue(e)}whenIdle(e){return this.idleRequestQueue.whenIdle(e)}setIdle(){this.terminated||this.idleRequestResponseQueue.addResponse(this)}}class E{constructor(){this.instanceRecords=[],this.idleInstanceRequestQueue=new f,this.idleInstanceResponseQueue=new f,this.idleInstanceRequestResponseQueue=new k(this.idleInstanceRequestQueue,this.idleInstanceResponseQueue)}terminate(){for(let e of this.instanceRecords)e.terminate()}terminateInstance(e){e.terminate();let t=this.instanceRecords.findIndex((t=>t===e));t>-1&&this.instanceRecords.splice(t,1)}terminateAllInstancesExcept(e){const t=this.instanceRecords.filter((t=>!e.includes(t)));for(const e of t)this.terminateInstance(e)}count(){return this.instanceRecords.length}idleCount(){return this.instanceRecords.filter((e=>e.idle)).length}async getIdleInstance(e){return await this.idleInstanceRequestResponseQueue.getResponse(e)}async getAtLeastOneIdleInstanceAndTerminateNonIdleOnes(e){const t=[],s=[],n=[];for(const r of this.instanceRecords)r.idle&&t.push(r),s.push(r.whenIdle(e).then((()=>{t.includes(r)||n.push(r)})));if(t.length>0)return this.terminateAllInstancesExcept(t),t;{await Promise.race(s);const e=n;return this.terminateAllInstancesExcept(e),e}}async whenAllInstancesIdle(e){const t=this.instanceRecords.slice();return await Promise.all(t.map((t=>t.whenIdle(e)))),t}registerInstance(e){const t=this.idleInstanceRequestQueue.useAsFallbackFor(new f),s=this.idleInstanceResponseQueue.embedQueue(),n=new y(e,t,s);return this.instanceRecords.push(n),n}}class P{constructor(e,t,s){this.instancePool=new E,this.instanceFactory=e,this.baseURI=s,this.maxNumberOfProcesses=t.maxNumberOfProcesses,this.gracefulQueryCancellation=void 0===t.gracefulQueryCancellation||!!t.gracefulQueryCancellation,this.config=t,this.pendingExecutions=[],this.executionFinished=new u.j,this.pendingInstanceCreations=[],this.latestInstanceId=0,this.latestRequestId=0,this.state=void 0}terminate(){this.instancePool.terminate();const e=this.pendingInstanceCreations.slice();for(let t of e)t.cancellationToken.cancel();const t=this.pendingExecutions.splice(0,this.pendingExecutions.length);for(let e of t)e.cancellationToken.cancel()}finishExecution(e){const t=this.pendingExecutions.indexOf(e);-1!==t&&(this.pendingExecutions.splice(t,1),this.executionFinished.dispatch(e),this.createInstanceIfNecessary())}async whenExecutionHasFinished(e,t){if(this.pendingExecutions.includes(e))return await(0,o.h)((0,a.h)(this.executionFinished,(t=>t===e)),t)}async whenNoMoreCommandsPending(e){const t=this.pendingExecutions.filter((e=>e.isCommand));0!==t.length&&await Promise.all(t.map((t=>this.whenExecutionHasFinished(t,e))))}cancelAllQueries(){const e=this.pendingExecutions.filter((e=>!e.isCommand));for(let t of e)t.cancellationToken.cancel()}createInstanceIfNecessary(){const e=this.pendingExecutions.filter((e=>!e.isCommand&&!e.cancellationToken.cancelled)).length,t=this.pendingExecutions.filter((e=>e.isCommand&&!e.cancellationToken.cancelled)).length,s=this.instancePool.count();e>s&&s<this.maxNumberOfProcesses&&0===t&&this.createNewInstance()}async performExecution(e,t,s,n){const i=new r(this.latestRequestId++,e,t,s);let u;this.pendingExecutions.push(i),this.createInstanceIfNecessary();try{u=await function(e,t){return Promise.race([c(t),e()])}((()=>n(i)),i.cancellationToken)}catch(e){throw new Error("execution was cancelled")}finally{this.finishExecution(i)}if(u.error)throw new Error(u.error);return u.result}async performExecutionOnInstance(e,t){const s=t.enqueueIdleRequestQueue(),n=(0,a.h)(t.onIdleRequested,(({executionId:t})=>t===e.id)),r=async(t,n)=>{e.cancellationToken.cancelled||(await s.whenIdle(e.cancellationToken),n())};n.addListener(r),(0,o.h)(e.cancellationToken).then((()=>{n.removeListener(r),t.removeIdleRequestQueue(s)}));const i=await t.performExecution({methodName:e.methodName,args:e.args,id:e.id});return n.removeListener(r),t.removeIdleRequestQueue(s),i}async executeQuery(e,t){return await this.performExecution(e,t,!1,(async e=>{const t=await this.instancePool.getIdleInstance(e.cancellationToken);if(e.cancellationToken.cancelled)return void t.setIdle();const s=await this.performExecutionOnInstance(e,t);return t.setIdle(),s}))}getInstancesForCommandExecution(e){return this.gracefulQueryCancellation?this.instancePool.whenAllInstancesIdle(e):this.instancePool.getAtLeastOneIdleInstanceAndTerminateNonIdleOnes(e)}async executeCommand(e,t){return await this.performExecution(e,t,!0,(async e=>{this.cancelAllQueries();const t=await this.getInstancesForCommandExecution(e.cancellationToken),s=t[0];s.allowIdle(!1);const n=await this.performExecutionOnInstance(e,s);s.allowIdle(!0),this.state=n.state;const r=t.filter((e=>e!==s));await Promise.all(r.map((e=>e.setState(n.state))));for(let e of t)e.setIdle();return n}))}async initializeInstance(e,t){t&&t.addListener((()=>{this.instancePool.terminateInstance(e)})),await this.whenNoMoreCommandsPending(t),await e.whenStarted();const s=await e.initialize(this.config,this.baseURI,this.state);if(s.error)throw this.instancePool.terminateInstance(e),new Error(s.error);return t&&t.cancelled||e.setIdle(),s.methodCollection}async createNewInstance(){const e=new i;this.pendingInstanceCreations.push(e);const t=this.instancePool.registerInstance(this.instanceFactory(this.latestInstanceId++));await this.initializeInstance(t,e.cancellationToken);const s=this.pendingInstanceCreations.indexOf(e);this.pendingInstanceCreations.splice(s,1)}initialize(){const e=this.instancePool.registerInstance(this.instanceFactory(this.latestInstanceId++));return this.initializeInstance(e)}static create(e,t,s){return new P(t,e,s)}}class S{constructor(e,t,s){for(let s of t)this[s]=function(...t){return e.executeQuery(s,t)};for(let t of s)this[t]=function(...s){return e.executeCommand(t,s)};this.terminate=()=>e.terminate()}}function L(e,t){return async function(s){const n=e(),r=P.create(s,(e=>t(n.createChildProcess(s))),n.baseURI),{queries:i,commands:u}=await r.initialize();return new S(r,i,u)}}},56:t=>{"use strict";t.exports=e},716:e=>{"use strict";e.exports=t}},n={};function r(e){var t=n[e];if(void 0!==t)return t.exports;var i=n[e]={exports:{}};return s[e](i,i.exports,r),i.exports}return r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r(138)})()}));